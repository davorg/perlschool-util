#!/usr/bin/env perl
use v5.32;
use warnings;
use experimental 'signatures';

use Getopt::Long qw(GetOptions);
use Path::Tiny;
use YAML::XS qw(LoadFile);
use Template;

# ------------------------------------------------------------
# Config / CLI
# ------------------------------------------------------------

my $metadata_file = 'book-metadata.yml';
my $keep_build    = 0;

GetOptions(
    'metadata=s'   => \$metadata_file,
    'keep-build!'  => \$keep_build,
) or die <<"USAGE";
Usage: make_book [--metadata book-metadata.yml] [--keep-build]
USAGE

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

sub run (@cmd) {
    say "+ @cmd";
    system @cmd;
    if ($? == -1) {
        die "Failed to execute @cmd: $!\n";
    } elsif ($? & 127) {
        die sprintf "Command @cmd died with signal %d\n", ($? & 127);
    } elsif ($? != 0) {
        die sprintf "Command @cmd exited with code %d\n", ($? >> 8);
    }
}

sub slugify ($s) {
    $s =~ s/^\s+|\s+$//g;
    $s = lc $s;
    $s =~ s/[^a-z0-9]+/-/g;
    $s =~ s/^-+|-+$//g;
    return $s;
}

# ------------------------------------------------------------
# Load metadata
# ------------------------------------------------------------

my $meta = LoadFile($metadata_file)
  or die "Failed to load $metadata_file\n";

for my $required (qw/title manuscript cover_image/) {
    die "Missing required key '$required' in $metadata_file\n"
      unless defined $meta->{$required} && length $meta->{$required};
}

my $title      = $meta->{title};
my $manuscript = $meta->{manuscript};
my $cover      = $meta->{cover_image};

my $output_base = slugify($title);

my $author           = $meta->{author}           // '';
my $subtitle         = $meta->{subtitle}         // '';
my $publisher        = $meta->{publisher}        // '';
my $isbn             = $meta->{isbn}             // '';
my $copyright_year   = $meta->{copyright_year}   // '';
my $copyright_holder = $meta->{copyright_holder} // $author // $publisher // '';

say "METADATA:";
say "  Manuscript : $manuscript";
say "  Title      : $title";
say "  Cover      : $cover";
say "  Output base: $output_base";

# ------------------------------------------------------------
# Directories
# ------------------------------------------------------------

my $build_dir = path('build');
my $built_dir = path('built');

# Clean build dir at start, then recreate
if ($build_dir->exists) {
    $build_dir->remove_tree({ safe => 0 });
}
$build_dir->mkpath;
$built_dir->mkpath;

# ------------------------------------------------------------
# Template Toolkit setup
# ------------------------------------------------------------

my $tt = Template->new({}) or die Template->error;

my $pdf_front_tmpl  = <<'PDF_TMPL';
[%# PDF front matter in Markdown %]

![Cover image]( [% cover_image %] )

<div class="page-break"></div>

# [% title %]

[% IF subtitle %]
## [% subtitle %]
[% END %]

[% IF author %]
### [% author %]
[% END %]

<div class="page-break"></div>

## Copyright

© [% copyright_year %] [% copyright_holder %]

All rights reserved.

[% IF publisher %]
Published by [% publisher %].
[% END %]

[% IF isbn %]
ISBN: [% isbn %]
[% END %]

<div class="page-break"></div>
PDF_TMPL

my $epub_front_tmpl = <<'EPUB_TMPL';
[%# EPUB front matter: copyright page only %]

## Copyright

© [% copyright_year %] [% copyright_holder %]

All rights reserved.

[% IF publisher %]
Published by [% publisher %].
[% END %]

[% IF isbn %]
ISBN: [% isbn %]
[% END %]
EPUB_TMPL

# ------------------------------------------------------------
# Render front matter + combine with manuscript
# ------------------------------------------------------------

my $manuscript_text = path($manuscript)->slurp_utf8;

# Build a context hash for templates
my %ctx = (
    %$meta,
    author           => $author,
    subtitle         => $subtitle,
    publisher        => $publisher,
    isbn             => $isbn,
    copyright_year   => $copyright_year,
    copyright_holder => $copyright_holder,
);

my ($pdf_front_md, $epub_front_md);

$tt->process(\$pdf_front_tmpl,  \%ctx, \$pdf_front_md)
  or die "Template error (PDF front matter): " . $tt->error . "\n";

$tt->process(\$epub_front_tmpl, \%ctx, \$epub_front_md)
  or die "Template error (EPUB front matter): " . $tt->error . "\n";

my $pdf_input   = $build_dir->child('pdf_input.md');
my $epub_input  = $build_dir->child('epub_input.md');
my $html_output = $build_dir->child('book.html');

$pdf_input->spew_utf8($pdf_front_md, "\n\n",  $manuscript_text);
$epub_input->spew_utf8($epub_front_md, "\n\n", $manuscript_text);

# ------------------------------------------------------------
# Build HTML for PDF
# ------------------------------------------------------------

run(
    'pandoc',
    $pdf_input->stringify,
    '--from=markdown',
    "--metadata-file=$metadata_file",
    '--template=perlschool.html',
    '--toc',
    '--toc-depth=2',
    '--standalone',
    '--resource-path=.:images',
    '-c', 'book-shared.css',
    '-c', 'book-pdf.css',
    '-o', $html_output->stringify,
);

# ------------------------------------------------------------
# Build PDF via wkhtmltopdf
# ------------------------------------------------------------

my $pdf_file = $built_dir->child("$output_base.pdf");

run(
    'wkhtmltopdf',
    '--enable-local-file-access',
    '--page-size', 'A4',
    '--margin-top',    '25mm',
    '--margin-bottom', '25mm',
    '--margin-left',   '25mm',
    '--margin-right',  '25mm',
    $html_output->stringify,
    $pdf_file->stringify,
);

# ------------------------------------------------------------
# Build EPUB via pandoc
# ------------------------------------------------------------

my $epub_file = $built_dir->child("$output_base.epub");

run(
    'pandoc',
    $epub_input->stringify,
    '--from=markdown',
    "--metadata-file=$metadata_file",
    '--template=perlschool.html',
    '--toc',
    '--toc-depth=2',
    '--standalone',
    '--resource-path=.',
    '-c', 'book-shared.css',
    "--epub-cover-image=$cover",
    '-o', $epub_file->stringify,
);

# ------------------------------------------------------------
# Tidy up
# ------------------------------------------------------------

unless ($keep_build) {
    say "Removing build directory...";
    $build_dir->remove_tree({ safe => 0 });
}

say "Built:";
say "  " . $pdf_file->stringify;
say "  " . $epub_file->stringify;

exit 0;

