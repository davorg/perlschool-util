#!/usr/bin/env perl
use v5.32;
use warnings;
use experimental 'signatures';

use Getopt::Long qw(GetOptions);
use Path::Tiny;
use YAML::XS qw(LoadFile);
use Template;
use FindBin qw($Bin);
use File::Copy::Recursive qw(dircopy);
use File::Copy qw(copy);

# ------------------------------------------------------------
# Config / CLI
# ------------------------------------------------------------

my $metadata_file = 'book-metadata.yml';
my $keep_build    = 0;

GetOptions(
  'metadata=s'   => \$metadata_file,
  'keep-build!'  => \$keep_build,
) or die <<"USAGE";
Usage: make_book [--metadata book-metadata.yml] [--keep-build]
USAGE

# ------------------------------------------------------------
# Helpers
# ------------------------------------------------------------

sub run (@cmd) {
  say "+ @cmd";
  system @cmd;
  if ($? == -1) {
    die "Failed to execute @cmd: $!\n";
  } elsif ($? & 127) {
    die sprintf "Command @cmd died with signal %d\n", ($? & 127);
  } elsif ($? != 0) {
    die sprintf "Command @cmd exited with code %d\n", ($? >> 8);
  }
}

sub slugify ($s) {
  $s =~ s/^\s+|\s+$//g;
  $s = lc $s;
  $s =~ s/[^a-z0-9]+/-/g;
  $s =~ s/^-+|-+$//g;
  return $s;
}

sub file_uri ($path) {
  my $abs = path($path)->absolute->stringify;
  $abs =~ s/ /%20/g;        # minimal escaping is enough here
  return "file://$abs";
}

# ------------------------------------------------------------
# Locate perlschool-utils resources (CSS, shared images)
# ------------------------------------------------------------

my $utils_root       = path($Bin)->parent->absolute;
my $css_dir          = $utils_root->child('css');
my $css_shared       = $css_dir->child('book-shared.css');
my $css_pdf          = $css_dir->child('book-pdf.css');
my $utils_images_dir = $utils_root->child('images');

for my $css ($css_shared, $css_pdf) {
  die "Missing CSS file: $css\n" unless $css->is_file;
}

say "UTILS:";
say "  Root       : $utils_root";
say "  CSS dir    : $css_dir";
say "  CSS shared : $css_shared";
say "  CSS pdf    : $css_pdf";
say "  Images dir : $utils_images_dir";

# ------------------------------------------------------------
# Load metadata
# ------------------------------------------------------------

my $meta = LoadFile($metadata_file)
  or die "Failed to load $metadata_file\n";

for my $required (qw/title manuscript cover_image/) {
  die "Missing required key '$required' in $metadata_file\n"
    unless defined $meta->{$required} && length $meta->{$required};
}

my $title      = $meta->{title};
my $manuscript = $meta->{manuscript};
my $cover      = $meta->{cover_image};

my $output_base = slugify($title);

my $author           = $meta->{author}           // '';
my $subtitle         = $meta->{subtitle}         // '';
my $publisher        = $meta->{publisher}        // '';
my $isbn             = $meta->{isbn}             // '';
my $copyright_year   = $meta->{copyright_year}   // '';
my $copyright_holder = $meta->{copyright_holder} // $author // $publisher // '';

say "METADATA:";
say "  Manuscript : $manuscript";
say "  Title      : $title";
say "  Cover      : $cover";
say "  Output base: $output_base";

# ------------------------------------------------------------
# Directories
# ------------------------------------------------------------

my $build_dir = path('build');
my $built_dir = path('built');

if ($build_dir->exists) {
  $build_dir->remove_tree({ safe => 0 });
}
$build_dir->mkpath;
$built_dir->mkpath;

# ------------------------------------------------------------
# Template Toolkit setup
# ------------------------------------------------------------

my $tt = Template->new({}) or die Template->error;

# FRONT MATTER FOR PDF (HTML fragment, not Markdown)
my $pdf_front_tmpl = <<'PDF_TMPL';
<section class="cover-page">
  <img class="cover-image" src="[% cover_image %]" alt="">
</section>

<section class="half-title">
  <h1>[% title %]</h1>
</section>

<section class="title-page">
  <h1>[% title %]</h1>
[% IF subtitle %]
  <h2 class="subtitle">[% subtitle %]</h2>
[% END %]
[% IF author %]
  <p class="author">[% author %]</p>
[% END %]
</section>

<section class="copyright-page">
  <p class="title">[% title %]</p>
  <p>&copy; [% copyright_year %] [% copyright_holder %] . All rights reserved.</p>

[% IF isbn -%]
  <p>ISBN: [% isbn %]</p>
[% END -%]

[% IF publisher -%]
  <p>Published by [% publisher %].</p>
[% END -%]

[% IF publisher_web -%]
  <p>[% publisher_web %]</p>
[% END -%]

  <p>No part of this publication may be reproduced, stored in a retrieval system, or
    transmitted in any form or by any means, electronic, mechanical, photocopying,
    recording or otherwise, without the prior written permission of the publisher,
    except in the case of brief quotations embodied in critical articles and reviews.</p>

  <p>The information in this book is distributed on an “as is” basis, without warranty.
    While every precaution has been taken in the preparation of this book, neither the
    author nor the publisher shall have any liability to any person or entity with
    respect to any loss or damage caused or alleged to be caused directly or indirectly
    by the instructions, examples, or other content contained in this book.</p>

  <p>Set in Markdown and typeset to PDF/ePub with Pandoc and wkhtmltopdf.</p>
</section>
PDF_TMPL

# EPUB still uses a simple Markdown copyright page
my $epub_front_tmpl = <<'EPUB_TMPL';
[%# EPUB front matter: copyright page only %]

*[% title %]*

&copy; [% copyright_year %] [% copyright_holder %]. All rights reserved.

[% IF isbn %]
ISBN: [% isbn %]
[% END %]

[% IF publisher %]
Published by [% publisher %].
[% END %]

[% IF publisher AND publisher_web -%]
[[% publisher%]](https://[% publisher_web %]/)
[% END -%]

No part of this publication may be reproduced, stored in a retrieval system, or
transmitted in any form or by any means, electronic, mechanical, photocopying,
recording or otherwise, without the prior written permission of the publisher,
except in the case of brief quotations embodied in critical articles and reviews.

The information in this book is distributed on an “as is” basis, without warranty.
While every precaution has been taken in the preparation of this book, neither the
author nor the publisher shall have any liability to any person or entity with
respect to any loss or damage caused or alleged to be caused directly or indirectly
by the instructions, examples, or other content contained in this book.

Set in Markdown and typeset to PDF/ePub with Pandoc and wkhtmltopdf.

EPUB_TMPL

# ------------------------------------------------------------
# Render front matter + read manuscript
# ------------------------------------------------------------

my $manuscript_text = path($manuscript)->slurp_utf8;

my %ctx = (
  %$meta,
  author           => $author,
  subtitle         => $subtitle,
  publisher        => $publisher,
  isbn             => $isbn,
  copyright_year   => $copyright_year,
  copyright_holder => $copyright_holder,
  cover_image      => $cover,
);

my $pdf_front_html;
$tt->process(\$pdf_front_tmpl, \%ctx, \$pdf_front_html)
  or die "Template error (PDF front matter): " . $tt->error . "\n";

my $epub_front_md;
$tt->process(\$epub_front_tmpl, \%ctx, \$epub_front_md)
  or die "Template error (EPUB front matter): " . $tt->error . "\n";

# For EPUB we still build a Markdown file: copyright page + manuscript
my $epub_input = $build_dir->child('epub_input.md');
$epub_input->spew_utf8($epub_front_md, "\n\n", $manuscript_text);

# ------------------------------------------------------------
# Prepare resources for wkhtmltopdf (images)
# ------------------------------------------------------------

my $book_images_dir  = path('images');
my $build_images_dir = $build_dir->child('images');

if ( $book_images_dir->is_dir ) {
  dircopy($book_images_dir->stringify, $build_images_dir->stringify)
    or die "Failed to copy images/ into build/images/\n";
}

my $logo_name  = 'perlschool-logo.png';
my $build_logo = $build_images_dir->child($logo_name);

if ( !$build_logo->is_file ) {
  my $utils_logo = $utils_images_dir->child($logo_name);
  if ( $utils_logo->is_file ) {
    $build_images_dir->mkpath;
    copy($utils_logo->stringify, $build_logo->stringify)
      or die "Failed to copy $utils_logo to $build_logo: $!\n";
  }
}

# ------------------------------------------------------------
# Build BODY+ToC HTML (chapters only) via pandoc
#   - No metadata file => no title block generated
#   - We keep the ToC
# ------------------------------------------------------------

my $body_html_path = $build_dir->child('body.html');

run(
  'pandoc',
  $manuscript,
  '--from=markdown',
  '--toc',
  '--toc-depth=2',
  '--standalone',
  '--resource-path=.:images',
  '-o', $body_html_path->stringify,
);

my $body_full = $body_html_path->slurp_utf8;

# Extract just the contents of <body>...</body>
$body_full =~ s{.*?<body[^>]*>}{}s;
$body_full =~ s{</body>.*}{}s;
my $body_inner = $body_full;

# ------------------------------------------------------------
# Stitch front matter HTML + body HTML into final book.html
# ------------------------------------------------------------

my $html_output = $build_dir->child('book.html');

my $css_shared_uri = file_uri($css_shared);
my $css_pdf_uri    = file_uri($css_pdf);

my $final_html = <<"HTML";
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>@{[ $title // '' ]}</title>
  <link rel="stylesheet" href="$css_shared_uri" />
  <link rel="stylesheet" href="$css_pdf_uri" />
</head>
<body>
$pdf_front_html

$body_inner
</body>
</html>
HTML

$html_output->spew_utf8($final_html);

# ------------------------------------------------------------
# Build PDF via wkhtmltopdf
# ------------------------------------------------------------

my $pdf_file = $built_dir->child("$output_base.pdf");

run(
  'wkhtmltopdf',
  '--enable-local-file-access',
  '--page-size', 'A4',
  '--margin-top',    '25mm',
  '--margin-bottom', '25mm',
  '--margin-left',   '25mm',
  '--margin-right',  '25mm',
  $html_output->stringify,
  $pdf_file->stringify,
);

# ------------------------------------------------------------
# Build EPUB via pandoc (mostly unchanged)
# ------------------------------------------------------------

my $epub_file = $built_dir->child("$output_base.epub");

my @epub_resource_paths = (
  '.',
  'images',
  $utils_images_dir->stringify,
);

run(
  'pandoc',
  $epub_input->stringify,
  '--from=markdown',
  "--metadata-file=$metadata_file",
  '--standalone',
  '--resource-path=' . join(':', @epub_resource_paths),
  '-c', $css_shared->stringify,
  "--epub-cover-image=$cover",
  '-o', $epub_file->stringify,
);

# ------------------------------------------------------------
# Tidy up
# ------------------------------------------------------------

unless ($keep_build) {
  say "Removing build directory...";
  $build_dir->remove_tree({ safe => 0 });
}

say "Built:";
say "  " . $pdf_file->stringify;
say "  " . $epub_file->stringify;

exit 0;
